---
title: "STATS 506 Problem 3"
author: "Lindsey Lin"
format: pdf
editor: visual
---

#### GitHub Repository Link:

```{r package_loading}
library(knitr)
library(haven)
library(tidyverse)
```

## Problem 1

a\. Download the file AUX_I from [this location](https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Examination&CycleBeginYear=2015), and determine how to **read it into R**. Then download the file DEMO_I from [this location](http://wwwn.cdc.gov/Nchs/Nhanes/Search/DataPage.aspx?Component=Demographics&CycleBeginYear=2015). Note that each page contains a link to a documentation file for that data set. **Merge the two** files to create a single `data.frame`. **Keep only records which matched**. Print out the **dimensions** of the merged `data.frame`.

```{r data_loading}
audiometry <- as.data.frame(read_xpt("AUX_I.xpt"))
demo <- as.data.frame(read_xpt("DEMO_I.xpt"))
merged_df <- merge(audiometry, demo, by = "SEQN")

dim(merged_df)
```

**Answer**:

Two files merged by `SEQN`, the returned data frame has 4582 rows and 119 columns.

b\. We’ll be using the **following variables.** Clean up each - ensure **all missing values are actually `NA`** (rather than `999` or something), and if it’s categorical, convert it to `factor` with informative `levels`.

-   Gender

-   Citizenship status

-   Number of children 5 years or younger in the household

-   Annual household income - There’s also an issue with the ordering of the categories here; take a look, identify the issue, and implement a solution.

```{r variable_selection_rename}
tymp_demo_df <- merged_df %>% 
  select("SEQN", 
         "tymp_right" = "AUXTWIDR",
         "tymp_left" = "AUXTWIDL",
         "gender" = "RIAGENDR",
         "citizenship" = "DMDCITZN",
         "num_children_5_younger" = "DMDHHSZA",
         "annual_income_code" = "INDHHIN2")

head(tymp_demo_df)
```

```{r variables_cleaning_labeling}
tymp_demo <- tymp_demo_df %>% 
  mutate(
    gender = factor(gender, 
                    levels = c(1, 2), 
                    labels = c("Male", "Female")),
    
    citizenship = case_when(citizenship %in% c(7, 9) ~ NA, 
                            TRUE ~ citizenship),
    
    citizenship = factor(citizenship,
                         levels = c(1, 2),
                         labels = c("U.S. citizen", "Not a citizen")),
    
    annual_income = case_when(annual_income_code %in% c(12, 13, 77, 99) ~ NA,
                              TRUE ~ annual_income_code),
    
    annual_income = factor(annual_income, 
                           ordered = TRUE, 
                           levels = c(1:10, 14, 15),
                           labels = c("$0–4,999", 
                                      "$5,000–9,999",
                                      "$10,000–14,999",
                                      "$15,000–19,999", 
                                      "$20,000–24,999", 
                                      "$25,000–34,999",
                                      "$35,000–44,999",
                                      "$45,000–54,999",
                                      "$55,000–64,999",
                                      "$65,000–74,999",
                                      "$75,000–99,999",
                                      "≥$100,000"))
         )
```

**Answer:**

I selected and renamed the columns needed in this problem. Then I cleaned and labeled the variables based on the NHANES documentation.

I converted `citizenship` into a factor and treated non-substantive responses as missing. Specifically, codes 7 = 'refused' and 9 = 'don’t know' were set to `NA`. Remaining codes were labeled 1 = U.S. citizen, 2 = Not a citizen.

The original `annual_income_code` is categorical and mixes detailed bins with two broad, overlapping buckets: 12 = “\$20,000 and over” and 13 = “under \$20,000.” Because 12 and 13 overlap the detailed ranges, they cannot be placed on the same ordered scale as 1–10, 14, 15. Also, 77 represents 'refused' and 99 represents 'don’t know' are nonresponses. Since codes 12 and 13 only contains 198 observations, to create a meaningful ordered factor, I set 12, 13, 77, 99 to `NA`, then labeled and ordered the remaining detailed bins from lowest to highest (I verified the ordering and counts with a frequency table to confirm the levels and the number of `NA`s introduced.)

```{r}
fre_table <- as.data.frame(table(tymp_demo$annual_income, useNA = "ifany"))
names(fre_table) <- c("Income Range", "Count")
                           
kable(fre_table, caption = "Distribution of annual household income")
```

c\. The Tympanometric width measure is looks approximately like a **Poisson distribution**. Fit four Poisson regression models predicting a respondent’s Tympanometric width **in each ear**. Each model is defined below, for a specific ear and a specific set of covariates.

-   1R - Right ear: gender

-   2R - Right ear: gender, citizenship status (as categorical), number of children (as continuous), annual household income (as continuous)

-   1L - Left ear: gender

-   2L - Left ear: gender, citizenship status (as categorical), number of children (as continuous), annual household income (as continuous)

Produce a table presenting the **estimated incidence risk ratios for the coefficients** in each model, along with the **sample size** for the model, the **pseudo-**$R^2$**,** and **AIC** values. (This can be a single table, or one table for coefficients and a separate table for model statistics).

```{r}
mid_income_point <- c("1"=2500, 
                      "2"=7500, 
                      "3"=12500, 
                      "4"=17500, 
                      "5"=22500,
                      "6"=30000, 
                      "7"=40000, 
                      "8"=50000, 
                      "9"=60000, 
                      "10"=70000,
                      "14"=87500, 
                      "15"=112500)

tymp_demo_c <- tymp_demo %>%
  mutate(income_cont = as.numeric(mid_income_point[as.character(annual_income_code)]))

# Fit four Poisson regression
m_1R <- glm(tymp_right ~ gender, data = tymp_demo_c, family = poisson)

m_2R <- glm(tymp_right ~ gender + citizenship + num_children_5_younger + income_cont,
            data = tymp_demo_c, family = poisson)

m_1L <- glm(tymp_left  ~ gender, data = tymp_demo_c, family = poisson)

m_2L <- glm(tymp_left  ~ gender + citizenship + num_children_5_younger + income_cont,
            data = tymp_demo_c, family = poisson)
```

Answer:

d\. From model 2L, provide evidence whether there is a difference between males and females in terms of their incidence risk ratio. Test whether the predicted value of Tympanometric width measure of the left ear differs between men and women. Include the results of the each test and their interpretation.
